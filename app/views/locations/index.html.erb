<%= content_tag :div, class: "locations_information", data: {locations: @locations} do %>
<% end %>

<div id="map"></div>

<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDfDMuS-T8EaT1i_72vzMG181Qm4GyXXos&callback=initMap">
</script>

<script type="text/javascript">
  var map;

  var markers=[];
  var marker;
  var addMarker;
  var labels = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  var labelIndex = 0;
  var loc_lat;
  var loc_lng;
  var myLatLng=[];

  var locations_information = $('.locations_information').data('locations');

  for (var i = 0; i < locations_information.length; i++) {
    var latLng = {lat: parseFloat(locations_information[i].loc_lat), lng: parseFloat(locations_information[i].loc_lng)};
    myLatLng.push(latLng);
  };

  function initMap() {

    map = new google.maps.Map(document.getElementById('map'), {
      center: {lat: <%= @trip.lat %>, lng: <%= @trip.lng %>},
      zoom: 15
    });
    // This event listener calls addMarker() when the map is clicked.
    google.maps.event.addListener(map, 'click', function(event) {
      addMarker(event.latLng, map);
    });

  }//initMaps


  function drop() {
    clearMarkers();
    for (var i = 0; i < myLatLng.length; i++) {
      addMarkerWithTimeout(myLatLng[i], i * 200);
    }
  }

  function addMarkerWithTimeout(position, timeout) {
    window.setTimeout(function() {
      markers.push(new google.maps.Marker({
        position: position,
        label: labels[labelIndex++ % labels.length],
        map: map,
        animation: google.maps.Animation.DROP
      }));
    }, timeout);
  }

  function clearMarkers() {
    for (var i = 0; i < markers.length; i++) {
      markers[i].setMap(null);
    }
    markers = [];
  }

  document.onload = drop();

  function addMarker(location, map) {
    // Add the marker at the clicked location, and add the next-available label
    // from the array of alphabetical characters.
      marker = new google.maps.Marker({
        position: location,
        label: labels[labelIndex++ % labels.length],
        map: map
      });
      markers.push(marker);
      loc_lat = marker.getPosition().lat();
      loc_lng = marker.getPosition().lng();
      debugger
      $('#location_loc_lat').val(loc_lat);
      $('#location_loc_lng').val(loc_lng);
    }//add markers

  // google.maps.event.addDomListener(window, 'load', initMap);

</script>

<div class="location_list">
  <table class="table table-hover">
    <thead>
      <tr>
        <th>Address</th>
        <th>Venue</th>
        <th colspan="3"></th>
      </tr>
    </thead>

    <tbody>
      <% @locations.each do |location| %>
        <tr>
          <td><%= location.address %></td>
          <td><%= location.venue %></td>
          <td><%= link_to 'Destroy', trip_location_path(@trip,location), method: :delete, data: { confirm: 'Are you sure?' } %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<div class="location_form">

  <%= form_for :location, url: trip_locations_path(@trip,@locations) do |f| %>
    Loc_lat: <%= f.text_field :loc_lat %> <br>
    Loc_lng: <%= f.text_field :loc_lng %> <br>
    Address: <%= f.text_field :address %> <br>
    Venue: <%= f.text_field :venue %> <br>
    <button type="submit" id="create_trip" class="create_trip">Create</button>
  <% end %>
  <%= link_to 'Back to Trip Plan', trips_path %>
</div>

